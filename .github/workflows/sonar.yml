name: SonarCloud Analysis

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Install Sonar Scanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Begin Sonar Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet-sonarscanner begin `
            /k:"pedrofonseca1227_GadoApi" `
            /o:"pedrofonseca1227" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.cs.opencover.reportsPaths="**\coverage.opencover.xml"

      - name: Test with Coverage
        run: dotnet test --configuration Release --collect:"XPlat Code Coverage"

      - name: Convert coverage to opencover
        shell: pwsh
        run: |
          $report = Get-ChildItem -Recurse -Filter "coverage.cobertura.xml" | Select-Object -First 1
          Write-Host "FILE FOUND: $($report.FullName)"
          
          dotnet tool install --global dotnet-reportgenerator-globaltool
          
          reportgenerator `
            "-reports:$($report.FullName)" `
            "-targetdir:coverage" `
            "-reporttypes:opencover"

      - name: End Sonar Analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
